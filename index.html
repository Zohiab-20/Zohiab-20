import React, { useEffect, useState } from "react";
import { initializeApp } from "firebase/app";
import {
  getAuth,
  signInWithPopup,
  GoogleAuthProvider,
  FacebookAuthProvider,
  signOut,
  onAuthStateChanged,
} from "firebase/auth";
import {
  getFirestore,
  collection,
  addDoc,
  query,
  orderBy,
  onSnapshot,
  serverTimestamp,
} from "firebase/firestore";

// --------- Apna Firebase config yahan daal ---------
const firebaseConfig = {
  apiKey: "YOUR_API_KEY_HERE",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID",
};
// -----------------------------------------------------

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

export default function ZohaibGaming() {
  const [user, setUser] = useState(null);
  const [comment, setComment] = useState("");
  const [comments, setComments] = useState([]);
  const [loading, setLoading] = useState(true);

  // Auth state listener
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
    });
    return () => unsubscribe();
  }, []);

  // Fetch comments realtime
  useEffect(() => {
    const q = query(collection(db, "comments"), orderBy("createdAt", "desc"));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const cmnts = [];
      snapshot.forEach((doc) => {
        cmnts.push({ id: doc.id, ...doc.data() });
      });
      setComments(cmnts);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // Login with Google
  const loginWithGoogle = async () => {
    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    } catch (err) {
      alert("Google Login failed: " + err.message);
    }
  };

  // Login with Facebook
  const loginWithFacebook = async () => {
    try {
      const provider = new FacebookAuthProvider();
      await signInWithPopup(auth, provider);
    } catch (err) {
      alert("Facebook Login failed: " + err.message);
    }
  };

  // Logout user
  const logout = () => {
    signOut(auth);
  };

  // Post new comment
  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!comment.trim()) return alert("Comment cannot be empty!");
    try {
      await addDoc(collection(db, "comments"), {
        text: comment,
        userId: user.uid,
        userName: user.displayName,
        createdAt: serverTimestamp(),
      });
      setComment("");
    } catch (err) {
      alert("Failed to post comment: " + err.message);
    }
  };

  return (
    <div style={{ maxWidth: 600, margin: "auto", fontFamily: "Arial, sans-serif" }}>
      <h1 style={{ textAlign: "center" }}>Subscribe Zohaib Gaming</h1>
      <div style={{ textAlign: "center", marginBottom: 10 }}>
        <a
          href="https://youtube.com/@zohaibfarroq-20?si=SkkV6BPNevwDkduz"
          target="_blank"
          rel="noreferrer"
          style={{ color: "red", textDecoration: "none", fontWeight: "bold" }}
        >
          YouTube Channel Link
        </a>
      </div>
      <p
        style={{
          fontWeight: "bold",
          whiteSpace: "nowrap",
          overflow: "hidden",
          boxSizing: "border-box",
          animation: "marquee 15s linear infinite",
          border: "1px solid #ccc",
          padding: "5px",
          marginBottom: 20,
        }}
      >
        Asphalt 8 all latest updates here, stay tuned!
      </p>

      {!user ? (
        <div style={{ textAlign: "center" }}>
          <button onClick={loginWithGoogle} style={{ marginRight: 10, padding: "8px 15px" }}>
            Login with Google
          </button>
          <button onClick={loginWithFacebook} style={{ padding: "8px 15px" }}>
            Login with Facebook
          </button>
        </div>
      ) : (
        <div>
          <p>
            Welcome, <b>{user.displayName}</b>{" "}
            <button onClick={logout} style={{ marginLeft: 10, padding: "5px 10px" }}>
              Logout
            </button>
          </p>

          <form onSubmit={handleSubmit} style={{ marginTop: 20 }}>
            <textarea
              value={comment}
              onChange={(e) => setComment(e.target.value)}
              rows={3}
              placeholder="Leave your comment here..."
              style={{ width: "100%", padding: 10, fontSize: 16 }}
            />
            <button type="submit" style={{ marginTop: 10, padding: "8px 15px" }}>
              Post Comment
            </button>
          </form>

          <div style={{ marginTop: 30 }}>
            <h3>Comments:</h3>
            {loading ? (
              <p>Loading comments...</p>
            ) : comments.length === 0 ? (
              <p>No comments yet.</p>
            ) : (
              comments.map((c) => (
                <div
                  key={c.id}
                  style={{
                    borderBottom: "1px solid #ddd",
                    padding: "10px 0",
                  }}
                >
                  <b>{c.userName || "Anonymous"}</b> <br />
                  <span>{c.text}</span> <br />
                  <small>{c.createdAt?.seconds ? new Date(c.createdAt.seconds * 1000).toLocaleString() : "Just now"}</small>
                </div>
              ))
            )}
          </div>
        </div>
      )}

      <style>{`
        @keyframes marquee {
          0% { transform: translateX(100%); }
          100% { transform: translateX(-100%); }
        }
      `}</style>
    </div>
  );
}
